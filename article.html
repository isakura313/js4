Heroku и React: деплоим свое первое приложение

Стартовый шаблон Create-react-app и Heroku - это прекрасные инструменты для быстрого создания работающих в облаке приложений, однако документация React и Heroku включает в себя на удивление немного информации, как все-таки выкатить свое React-приложение на Heroku. Шаги, описанные в этой статье, сработают на любом проекте, созданном с помощью create-react-app. В нашей статье мы задеплоим на Heroku простое todo-приложение с самым минимальным бекэндом, просто чтобы посмотреть на сам процесс. На обо всем по порядку:
<cut />
<h3> Что такое вообще Heroku? Зачем он мне нужен? </h3>
Heroku - это облачная платформа как услуга (PaaS), которая поддерживает множество языков программирования (и этим она очень хвастается и выделяется). История Heroku началась в 2007, и тогда первым языком программирования был Ruby. Теперь она поддерживает Java, Node.js, Scala, Clojure, Python, PHP и Go.

<h3> А зачем мне это облако? Я вот могу хостинг недорогой купить</h3> 
Да, вы можете купить себе любой хостинг и установить туда Node.js сервер, если на хостинге поддерживается эта услуга. Однако облачные платформы, обладают, к примеру, такими качествами, как эластичность и учет потребления - если на ваш сервис заходит очень много пользователей, тогда платформа скорее всего автоматически (или вы сами с помощью предоставленных платформой инструментов), отмасштабирует или сузит поток. Учет потребления означает, что вы заплатите только за те ресурсы, которые оказались востребованы. Облачные платформы имеют еще множество преимуществ, с полным списком можно ознакомиться <a href="https://medium.com/@kumarshivam_66534/a-walk-through-on-iaas-paas-and-saas-7e8a4e4793fb"> здесь</a>. Ну а мы перейдем непосредственно к деплою.

<h5> Создание своего React приложения </h5>
 Что это вообще за шаблон create-react-app? Хоть немного заниматься разработкой React приложений и не знать про него, наверное, невозможно. Этот шаблон предоставляет React, React-dom, Webpack, ESLint "под капотом". Конечно, вы можете сами собрать свое React - приложение, но зачем плодить себе сложное приложение с кучей зависимостей, когда можно воспользоваться уже готовым велосипедом? 
 Для начала практических шагов убедитесь, что у вас установлена Node.js.

 Что бы создать новое приложение, введите в консоль следующие команды:
<source>
 npx create-react-app test-app
 cd test-app
</source>
 <spoiler title="Полезное замечание"> Для того, чтобы у вас все заработало, нужно поставить create-react-app глобально. Для этого нужно ввести команду npm install -g create-react-app. Однако если вы ставили уже (насколько я понимаю историю коммитов этого шаблона, то ранее прошлого года), у вас может генерироваться ошибка пути из-за того, что нужно обновить react-scripts на новую версию на 3.4.0. Но чтобы избежать ошибки и в следующих генерациях, вам нужно деинсталировать текущую версию пакета при помощи npm uninstall -g create-react-app. </spoiler> 
 
Отлично, вы поставили пакет, теперь вы хотите задеплоить это. Для, чтобы не деплоить простой пакет с одним компонентом, который create-react-app поставляет "из коробки", я решил написать небольшое todo-приложение, с исходным кодом которого, если вы тоже хотите попробовать залить свое приложение, можно ознакомиться <a href="https://github.com/isakura313/art_todo"> здесь</a>. Если вкратце, то там идет сохранение состояния в виде нового и модного entries, где сохраняются текст дел и их id, которое генерируется напрямую из Date.now(). Часть верстки компонентов я взял из Material-UI react.
Можете поставить это приложение себе и развернуть его при помощи:
<source>
 npm i -D
 npm start
</source>
Дальше у вас есть невероятная возможность поиграться и создавать свои дела. Однако все возможности, что у нас есть в данном приложении - это сохранять свои дела в state. Никакой подвязки к серверу или хотя бы к localStorage я не делал, цель этой статьи состоит не в этом. Положим, вы очень сильно параноик, и ваши дела вы будете записывать только за одно включение вкладки браузера.

<h5>Создание своего favicon</h5>
Зачем нам вообще нужен Node.js сервер, если никакой работы с БД не проводится? С помощью сервера мы будет отдавать наш favicon и весь остальный код. В нашем React-приложении заходим в папку public и удаляем оттуда шаблонный favicon.ico. Я возьму иконку <a href="https://icon-icons.com/icon/checklist-list-tasks-todo/106575">отсюда</a> и перенесу ее в папку public.

<h5>Создаем свой Express-сервер</h5>
Дальше мы создаем свой Express сервер для обслуживания нашего билда. Прямо в папке вашего приложения создаем файл server.js, в котором и развернется работа нашего бекенда.
Пишем в нем следующее:
<source lang="javascript">
 const express = require('express');
 const favicon = require('express-favicon');
 const path = require('path');
 const port = process.env.PORT || 8080;
 
 // здесь у нас происходит импорт пакетов и определяется порт нашего сервера
 const app = express();
 app.use(favicon(__dirname + '/build/favicon.png')); 
 
 //здесь наше приложение отдаёт статику
 app.use(express.static(__dirname));
 app.use(express.static(path.join(__dirname, 'build')));
 
 //простой тест сервера
 app.get('/ping', function (req, res) {
  return res.send('pong');
 });
 
 //обслуживание html
 app.get('/*', function (req, res) {
 res.sendFile(path.join(__dirname, 'build', 'index.html'));
 });
 app.listen(port);
</source>

Так как мы используем пакеты express, express-favicon и path, их нужно проинсталлировать:
<source>
 yarn add express express-favicon path -D
</source>
В package.json изменяем команду start на следующую:
<source>
 "start": "node server.js",
</source>
 <h5> Запускаем build</h5>
Дальше нам нужно забилдить наше приложение с помощью следующей команды:
 <source>
 yarn build
 </source>
 Неплохо было бы потестировать, что наше приложение работает корректно. Для этого набираем yarn start и оцениваем, насколько корректно оно работает. 

 <h5> Скрываем sourcemap</h5>
 Возможно, вы не хотите, чтобы кто-то мог получить доступ к вашему исходному коду. В этом случае вам нужно снять доступ к вашим sourcemap. Для этого создаете в репозитории файл .env и запрещаете в нем генерацию карт:
 <source>
 GENERATE_SOURCEMAP=false
 </source>
 <spoiler title="Полезное замечание"> Source map упрощают дебаг кода непосредственно на продакшене (я понимаю, что дебаг, тесты, и комменты на проде это святое, но все-таки так делать нельзя). Самый грамотный ход - создать себе отдельную ветку с source map, на которой вы и будете дебажить, и отдельную в сам прод.
 </spoiler>
  
  <h5> Непосредственно деплой</h5>
  Если у вас еще нет аккаунта на heroku, вам стоит зарегестрироваться <a href="https://signup.heroku.com/">здесь </a>. Для деплоя вам также потребуется установить Heroku CLI <a href="https://devcenter.heroku.com/articles/heroku-cli">отсюда</a>. Проверьте его работу, написав heroku login в командную строку. Дальше вас ждет редирект на сайт heroku, где нужно авторизоваться.
 Потом вводим имя вашего приложения. В моем случае это будет todoisakura313, потому что использовать спецсимволы и нижние подчеркивания в имени приложения нельзя:
 <source>
 heroku create todoisakura313
 </source>
 Потом мы отправим наш билд с помощью следующих команд:
 <source>
 npm install
 git add --all
 git commit -m "first commit"
 git push heroku master 
 </source>

 Эти команды позволят нам поставить зависимости, инициализировать git, и загрузить само приложение. 
 Отлично! В общем все готово, сейчас приложение уже должно появиться по адресу https://<название вашего приложения>.herokuapp.com/. Вы можете открыть ваше приложение, набрав в консоли следующие команды:
 <source>
  heroku open
 </source>

 Если что-то пошло не так, узнать, в чем дело можно с помощью команды heroku logs --tail. Однако, в общем, если вы не отклонялись от инструкций данной статьи, у вас все должно было получиться. 
 На этом все! Спасибо за внимание. С работающим приложением можно ознакомиться <a href="https://todoisakura313.herokuapp.com/">здесь</a>, а с его готовым кодом - <a href="https://github.com/isakura313/art_test">здесь</a>.